name: ü•¢ Spell check 

on:
  pull_request:
    branches:
      - main
jobs:
  typo_check:
    name: ü•¢ Spell check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    env: 
      TYPOS: ""
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 2

      - name: Find and check typos in mdx files
        id: find_typos
        run: |
          echo "Checking for typos..."
          set -o pipefail
          # Run cspell and capture output, but don't fail yet
          output=$(npx cspell lint "docs/pages/**/*.mdx" --no-progress --no-summary || true)

          if [[ -n "$output" ]]; then
            echo "Typos found, formatting output..."
            
            # Format output with numbered lines and backticks around filenames
            formatted_output=""
            while IFS= read -r line; do
              if [[ -n "$line" ]]; then
                # Extract the numbered format and wrap filename in backticks
                # Expected format: " 1. docs/pages/file.mdx:72:46 - Unknown word (Acivity)"
                if [[ $line =~ ^[[:space:]]*([0-9]+\.)[[:space:]]*(.+):([0-9]+):([0-9]+)[[:space:]]*-[[:space:]]*(.+)$ ]]; then
                  number="${BASH_REMATCH[1]}"
                  file="${BASH_REMATCH[2]}"
                  line_num="${BASH_REMATCH[3]}"
                  col_num="${BASH_REMATCH[4]}"
                  error_desc="${BASH_REMATCH[5]}"
                  
                  # Format with backticks around filename
                  formatted_output+="$number \`$file\`:$line_num:$col_num - $error_desc"$'\n'
                else
                  # Fallback: just add the line as-is
                  formatted_output+="$line"$'\n'
                fi
              fi
            done <<< "$output"
            
            TYPOS+="### üìÑ docs/pages:"
            TYPOS+=$'\n'
            TYPOS+='```'
            TYPOS+=$'\n'
            TYPOS+="$formatted_output"
            TYPOS+='```'
            TYPOS+=$'\n\n'
            {
              echo 'TYPOS<<EOF'
              echo "$TYPOS"
              echo EOF
            } >> "$GITHUB_ENV"
          fi

      - name: Comment on pull request
        if: env.TYPOS != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const author = '${{github.event.pull_request.user.login}}';
            const typos = process.env.TYPOS;
            const body = `
            Hi @${author},

            Following typos were found in the pull request:
            
            ${typos}

            ## ‚ÑπÔ∏è Here's how to fix them:
            - **Fix typos:** Open the relevant files and fix any identified typos.
            - **Update wordlist:** If a flagged word is actually a project-specific term add it to \`wordlist.txt\` in the project root.
              Each word should be listed on a separate line.
            - **üöß Remember:**
              - When adding new words it MUST NOT have any spaces or special characters within or around it.
              - \`wordlist\` is NOT case sensitive.
              - If code variables are flagged, wrap them in backticks instead of adding them to the \`wordlist\`. This way they are treated as code and won‚Äôt bloat the \`wordlist\` with project-specific identifiers.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

            core.setFailed('ü•¢ Spell check: Typos found in docs. Please fix them.');
