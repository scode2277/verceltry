name: Upload MDX Images to S3

on:
  push:
    branches:
      - main

jobs:
  upload-images:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-north-1

      - name: Find all MDX files
        run: |
          find . -type f -name "*.mdx" > mdx_list.txt
          echo "MDX files found:"
          cat mdx_list.txt

      - name: Extract image paths and upload
        run: |
          # Prepare image list
          > images.txt
          while read mdx; do
            grep -oP '(?<=\]\()\./.*\.(png|jpg|jpeg|gif)' "$mdx" >> images.txt || true
            grep -oP '(?<=src=")\./.*\.(png|jpg|jpeg|gif)' "$mdx" >> images.txt || true
          done < mdx_list.txt

          # Deduplicate
          sort -u images.txt -o images.txt

          # Upload images and update MDX links
          while read img; do
            if [ -f "$img" ]; then
              s3_path="${img#./}"  # remove leading ./
              echo "Uploading $img to s3://frameworks-try/$s3_path ..."
              aws s3 cp "$img" "s3://frameworks-try/$s3_path" --acl public-read

              # Replace relative path with S3 URL in all MDX files
              while read mdx; do
                sed -i "s|$img|https://frameworks-try.s3.eu-north-1.amazonaws.com/$s3_path|g" "$mdx"
              done < mdx_list.txt
            fi
          done < images.txt

      - name: Commit updated MDX files
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git add $(cat mdx_list.txt)
          git commit -m "Upload images to S3 and update MDX links" || echo "No changes"
